 <!-- TODO: 
	1. Take out curve, leave stocks price only.
	2. Dynamic add stocks.
-->
	<head>
		<meta charset="utf8">
		<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
		<style type="text/css">
			.stocks {
				height: 30px;
			}
		</style>
	</head>
	<body>

	<script>
		var stocks = [
				{ "number": '1464', "name": "得力", "price": '0', 'buy_price': '31.45' },
				{ "number": '2201', "name": "裕隆", "price": '0', 'buy_price': '35.85' },
				{ "number": '0050', "name": "台灣50", "price": '0', 'buy_price': '69.5' },
				{ "number": '2412', "name": "中華電", "price": '0', 'buy_price': '97' },
			];
            
        var currencies = [
                {"from": "USD", "to": "TWD"},
                {"from": "JPY", "to": "TWD"}
            ];
		var refreshStock = function(stock){
			$.ajax({
				// The 'type' property sets the HTTP method.
				// A value of 'PUT' or 'DELETE' will trigger a preflight request.
				type: 'GET',

				// The URL to make the request to.
				url: 'https://finance.google.com/finance/info?client=ig&q=TPE:' + stock.number,
				dataType: 'jsonp',
				cache: false,
				success: function(response){
					var change = (parseFloat(response[0]['l']) - parseFloat(stock.buy_price)).toFixed(2);
					var change_str = '';
					if(change > 0){
						change_str = '+' + change + '元';
					} else if(change < 0){
						change_str = '-' + change + '元';
					} else {
						change_str = '--';
					}

					//console.log('(' + stock.number + '): ' + response[0]['l_cur']); //debug
					$('#' + stock.name).text('' + stock.name+ '(' + stock.number + '): ' 
						+ response[0]['l_cur'] + '  [買價：' + stock.buy_price
						+ '  漲跌：' + change_str + ']');
   						
					if(stock.price < response[0]['l'])
					{
						$('#' + stock.name).fadeTo(10, 1, function(){
							$(this).css("background-color", "red");
    						}).fadeTo(500, 0, function(){
							$(this).css("background-color", "white");
						}).fadeTo(1, 1, function(){
							$(this).css("background-color", "white");
						});
	
						stock.price = response[0]['l']; 
					}
					else if(stock.price > response[0]['l'])
					{
						$('#' + stock.name).fadeTo(10, 1, function(){
							$(this).css("background-color", "green");
    						}).fadeTo(500, 0, function(){
							$(this).css("background-color", "white");
						}).fadeTo(1, 1, function(){
							$(this).css("background-color", "white");
						});
	
						stock.price = response[0]['l']; 
					}
				}	 
			});	
		}
        
        var refreshExchange = function(currency){
            $.ajax({
				// The 'type' property sets the HTTP method.
				// A value of 'PUT' or 'DELETE' will trigger a preflight request.
				type: 'GET',

				// The URL to make the request to.
				url: 'https://currency-api.appspot.com/api/'+currency.from + '/' + currency.to + '.jsonp',
				dataType: 'jsonp', 
				cache: false,
				success: function(response){
                    //response: Object {success: true, source: "JPY", target: "TWD", rate: 0.2655651, amount: 0.27, message: ""}
                    if (response.success) { 
                        $('#' + currency.from + '_' + currency.to)
                            .text(currency.from + ' to ' + currency.to + ': ' + parseFloat(response.rate).toFixed(2));
                    }
                }
            });
        }

		$(document).ready(function(){
			for( var s in stocks ){
				
				$('body').append('<div id="' + stocks[s].name + '" class="stocks">'  
					+ stocks[s].name + '(' + stocks[s].number + '): '+'</div>');
			}
            
            for( var c in currencies){
                $('body').append('<div id="' + currencies[c].from + '_' + currencies[c].to + '" class="stocks">' 
                    + currencies[c].from + ' to ' + currencies[c].to + ': ' + '</div>');
            }
		});

		setInterval(function() {		   
			for( var s in stocks ){
				//console.log(stocks[s].number);  //debug
				refreshStock(stocks[s]);
			}
            
            for(var c in currencies){
                refreshExchange(currencies[c]); 
            }
		}, 2000);	
	
	</script>
</body>
